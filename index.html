<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>DBMS DA-2 Project</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .navbar { background-color: #ffffff; border-bottom: 1px solid #dee2e6; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .navbar-brand { color: #0d6efd !important; font-weight: 600; }
        .card { border: 1px solid #dee2e6; box-shadow: 0 4px 8px rgba(0,0,0,0.05); }
        .card-header { background-color: #f8f9fa; font-weight: 500; }
        .scrollable-table { max-height: 400px; overflow-y: auto; }
        footer { background-color: #ffffff !important; color: #6c757d !important; border-top: 1px solid #dee2e6; }
        .btn-group-custom .btn { margin: 5px; }
    </style>
</head>
<body>

    <nav class="navbar navbar-light"><div class="container-fluid"><a class="navbar-brand" href="#">DBMS DA-2 Project: Wholesale Price Index Analysis</a></div></nav>

    <div class="container mt-4">

        <div class="card mb-4">
            <div class="card-header"><h3>Raw Data Preview (First 100 Rows)</h3></div>
            <div class="card-body">
                <p class="card-text text-muted">A sample from the original CSV to help you write queries.</p>
                <div id="preview-container" class="scrollable-table border rounded">Loading preview...</div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header"><h3>Common Queries</h3></div>
            <div class="card-body btn-group-custom">
                <button class="btn btn-primary" data-api="/api/top-commodities">Top 10 Commodities (Avg. Index)</button>
                <button class="btn btn-primary" data-api="/api/most-volatile">Top 10 Most Volatile</button>
                <button class="btn btn-primary" data-api="/api/most-stable">Top 10 Most Stable</button>
                <button class="btn btn-primary" data-api="/api/highest-peak">Top 10 Highest Peaks</button>
                <button class="btn btn-primary" data-api="/api/lowest-trough">Top 10 Lowest Troughs</button>
                <button class="btn btn-info" data-api="/api/recent-entries">10 Most Recent Entries</button>
                <button class="btn btn-info" data-api="/api/onion-prices">"Onion" Price Trend</button>
                <button class="btn btn-info" data-api="/api/yearly-average">Overall Yearly Average</button>
                <button class="btn btn-info" data-api="/api/unique-commodities">Count Unique Commodities</button>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header"><h3>Custom SQL Query Runner</h3></div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="sqlQuery" class="form-label">Enter your SQL query below:</label>
                    <textarea id="sqlQuery" class="form-control" rows="5" placeholder="SELECT * FROM wholesale_prices LIMIT 10;"></textarea>
                </div>
                <button id="executeQueryBtn" class="btn btn-success">Execute Query</button>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header"><h3>Results</h3></div>
            <div class="card-body">
                 <div id="results-container">Click a button or run a custom query to see results here.</div>
            </div>
        </div>

    </div>

    <footer class="text-center py-4 mt-5">
        <p class="mb-0"><strong>SHUBH GUPTA</strong> - 23BLC1322</p>
        <p class="mb-0"><small>Data Source: data.gov.in - Wholesale Price Index (2013-Present)</small></p>
    </footer>

    <script>
        const resultsDiv = document.getElementById('results-container');
        const previewDiv = document.getElementById('preview-container');
        
        window.addEventListener('load', () => {
            fetchAndDisplayData('http://127.0.0.1:5000/api/raw-data-preview', previewDiv);
        });

        document.querySelectorAll('.btn-group-custom .btn').forEach(button => {
            button.addEventListener('click', () => {
                const apiUrl = `http://127.0.0.1:5000${button.dataset.api}`;
                fetchAndDisplayData(apiUrl, resultsDiv);
            });
        });

        document.getElementById('executeQueryBtn').addEventListener('click', () => {
            const query = document.getElementById('sqlQuery').value;
            postAndDisplayData(query);
        });

        function fetchAndDisplayData(apiUrl, targetDiv) {
            targetDiv.innerHTML = '<div class="d-flex justify-content-center"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>';
            fetch(apiUrl)
                .then(response => response.json().then(data => ({ status: response.status, body: data })))
                .then(res => handleResponse(res, targetDiv))
                .catch(error => handleError(error, targetDiv));
        }

        function postAndDisplayData(query) {
            resultsDiv.innerHTML = '<div class="d-flex justify-content-center"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>';
            fetch('http://127.0.0.1:5000/api/execute-query', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ query: query })
            })
            .then(response => response.json().then(data => ({ status: response.status, body: data })))
            .then(res => handleResponse(res, resultsDiv))
            .catch(error => handleError(error, resultsDiv));
        }

        function handleResponse(res, targetDiv) {
            if (res.status !== 200) {
                targetDiv.innerHTML = `<div class="alert alert-danger">Error: ${res.body.error}</div>`;
                return;
            }
            const data = res.body;
            if (data.length === 0) {
                targetDiv.innerHTML = '<div class="alert alert-info">Query executed successfully, but returned no results.</div>';
                return;
            }
            const headers = Object.keys(data[0]);
            let tableHTML = '<table class="table table-striped table-hover"><thead><tr>';
            headers.forEach(header => tableHTML += `<th>${header}</th>`);
            tableHTML += '</tr></thead><tbody>';
            data.forEach(row => {
                tableHTML += '<tr>';
                headers.forEach(header => tableHTML += `<td>${row[header]}</td>`);
                tableHTML += '</tr>';
            });
            tableHTML += '</tbody></table>';
            targetDiv.innerHTML = tableHTML;
        }

        function handleError(error, targetDiv) {
            console.error('Fetch error:', error);
            targetDiv.innerHTML = `<div class="alert alert-danger">Network Error: Could not connect to the server.</div>`;
        }
    </script>
</body>
</html>